<style>
  #filter-btn-swiper .swiper-slide {
    width: auto !important;
  }

  .filter-btn {
    border: 1px solid #bec0c2;
    border-radius: 20px;
    padding: 5px 25px;
    background: #fff;
    cursor: pointer;
    white-space: nowrap;
  }

  .filter-btn.active {
    background: #414042;
    color: #fff;
  }
</style>
<style>
  /* Modal Overlay */
  .quick-view-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .quick-view-overlay.active {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
  }

  /* Modal Container */
  .quick-view-modal {
    background: white;
    border-radius: 8px;
    max-width: 900px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: transform 0.3s ease;
    position: relative;
  }

  .quick-view-overlay.active .quick-view-modal {
    transform: scale(1);
  }

 
</style>

<style>
  /* Navigation visibility */
  .ts-prev.swiper-button-disabled,
  .ts-next.swiper-button-disabled {
    opacity: 0;
    pointer-events: none;
  }

  .ts-prev,
  .ts-next {
    transition: opacity 0.3s ease;
  }

  /* Progress Bar Scoped to Top Sellers */
  .ts-progress-bar {
    width: 100%;
    height: 4px;
    background-color: #e9e9e9;
    border-radius: 2px;
    margin-top: 30px;
    position: relative;
    overflow: hidden;
  }

  .ts-progress-thumb {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background-color: #414042;
    border-radius: 2px;
    /* Using transform for performance, but the calculation is fixed below */
    transition: transform 0.5s ease;
    width: 0; /* Set dynamically by JS */
  }
</style>
<div class="custom-container mt-20!">
  <div class="flex item-center justify-between">
    <h1 class="text-[24px] font-bold text-[#414042] mb-4">Browse Top Sellers</h1>
    <a href="#" class="text-[#006A2E]! hidden md:flex items-center"
      >Shop all {% render 'svg-icons', name: 'chevron-right', icon_class: 'w-[20px] h-[20px] stroke-[#006A2E]' %}
    </a>
  </div>

  <div class="swiper" id="filter-btn-swiper">
    <div class="swiper-wrapper">
      {% for block in section.blocks %}
        <button
          class="swiper-slide filter-btn {% if forloop.first %}active{% endif %}"
          data-filter="{{ block.settings.tag | downcase }}"
          {{ block.shopify_attributes }}
        >
          {{ block.settings.label }}
        </button>
      {% endfor %}
    </div>
  </div>

  <div class="my-5">
    <div class="swiper py-10 relative" id="products-swiper">
      {% if section.settings.show_navigation %}
        <div
          class="
            ts-prev
            prev-swiper-button absolute left-0 top-1/2 -translate-y-1/2 z-10
            rounded-full cursor-pointer w-[40px] h-[40px]
            flex items-center justify-center bg-white shadow-xl
          "
        >
          {% render 'svg-icons', name: 'right-arrow', icon_class: 'w-[20px] h-[20px] rotate-180' %}
        </div>
      {% endif %}
      {% assign collection = collections['best-seller-products'] %}
      <div class="swiper-wrapper">
        {% if collection %}
          {% for product in collection.products %}
            {%- comment %}<locksmith:3fc9>{% endcomment -%}
              {%- capture var %}{% render 'locksmith-variables', scope: 'subject', subject: product, subject_parent: collection, variable: 'transparent' %}{% endcapture %}{% if var == "true" %}{% else %}{% continue %}{% endif -%}
            {%- comment %}</locksmith:3fc9>{% endcomment -%}
            <div
              class="swiper-slide w-[260px]!"
              data-tags="{{ product.tags | join: ',' | downcase }}"
            >
              <div class="w-[260px]! border border-transparent hover:border-[#0000001f] rounded-md p-2">
                <div class="relative bg-[#FAFAFA] rounded-md flex items-center justify-center">
                  <img
                    src="{{ product.featured_image | image_url: width: 900 }}"
                    alt="{{ product.title }}"
                    class="object-contain h-auto w-full"
                  >
                  {% if product.metafields.custom.on_sale %}
                    <span class="absolute top-1 left-1 bg-[#CC4848] text-white text-[12px] font-normal rounded-sm px-2.5 py-0.5">
                      sale
                    </span>
                  {% endif %}
                </div>

                <div class="mt-4">
                  <p class="text-[18px] font-semibold text-[#2B2B2B]">
                    {{ product.price | money }}
                  </p>

                  {% if product.compare_at_price > product.price %}
                    <p class="text-[14px] text-[#9B9B9B] line-through">
                      {{ product.compare_at_price | money }}
                    </p>
                  {% endif %}
                </div>

                <a href="{{ product.url }}" class="mt-2 text-[14px] leading-[20px] text-[#414042]">
                  {% assign title_parts = product.title | split: ' ' %}
                  <strong>{{ title_parts[0] }}</strong>
                  {{ title_parts | slice: 1, title_parts.size | join: ' ' }}
                </a>

                <button
                  class="quick-view-btn relative group mt-4 w-full bg-[#006A2E] text-white text-[14px] font-medium py-2 rounded-sm hover:bg-[#005025] transition-colors"
                  data-product-handle="{{ product.handle }}"
                  data-product-price="{{ product.price | money }}"
                  data-product-compare-price="{% if product.compare_at_price > product.price %}{{ product.compare_at_price | money }}{% endif %}"
                >
                  Quick View
                  <div
                    class="btn-overlay absolute  bg-white z-10 w-full h-full top-0 left-0 opacity-0 scale-30 rounded-sm group-hover:scale-100 group-hover:opacity-30 duration-500 transition-all"
                  ></div>
                </button>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
      {% if section.settings.show_navigation %}
        <div
          class="
            ts-next
            next-swiper-button absolute right-0 top-1/2 -translate-y-1/2 z-10
            rounded-full cursor-pointer w-[40px] h-[40px]
            flex items-center justify-center bg-white shadow-xl
          "
        >
          {% render 'svg-icons', name: 'right-arrow', icon_class: 'w-[20px] h-[20px]' %}
        </div>
      {% endif %}
    </div>
    {% if section.settings.show_progress_bar %}
      <div class="ts-progress-bar">
        <div class="ts-progress-thumb" id="tsProgressThumb"></div>
      </div>
    {% endif %}
  </div>
</div>

<div class="quick-view-overlay" id="quickViewModal">
  <div class="quick-view-modal">
  

    
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const filterSwiper = new Swiper('#filter-btn-swiper', {
      slidesPerView: 'auto',

      spaceBetween: 10,

      freeMode: true,
    });
    const tsThumb = document.getElementById('tsProgressThumb');

    const productSwiper = new Swiper('#products-swiper', {
      slidesPerView: 'auto',
      spaceBetween: 25,
      watchOverflow: true,
      navigation: {
        nextEl: '.ts-next',
        prevEl: '.ts-prev',
        disabledClass: 'swiper-button-disabled',
      },

      breakpoints: {
        320: {
          slidesPerView: 2,
          spaceBetween: 10,
        },
        640: {
          slidesPerView: 2,
          spaceBetween: 16,
        },
        768: {
          slidesPerView: 3,
          spaceBetween: 16,
        },
        1024: {
          slidesPerView: 4,
          spaceBetween: 16,
        },
      },

      on: {
        init: function () {
          updateTsProgress(this);
        },
        // 'setTranslate' catches dragging, 'slideChange' catches arrows
        setTranslate: function () {
          updateTsProgress(this);
        },
        breakpoint: function () {
          updateTsProgress(this);
        },
      },
    });

    function updateTsProgress(swiperInstance) {
      if (!tsThumb) return;

      // Filtered slides might be hidden, we only count visible ones
      const visibleSlidesCount = swiperInstance.slides.filter((slide) => slide.style.display !== 'none').length;
      if (visibleSlidesCount <= 1) {
        tsThumb.parentElement.style.display = 'none';
        return;
      } else {
        tsThumb.parentElement.style.display = 'block';
      }

      // Calculate width based on the current view
      const swiperWidth = swiperInstance.width;
      const totalContentWidth = swiperInstance.virtualSize;
      const thumbWidthPercent = Math.max((swiperWidth / totalContentWidth) * 100, 10);

      tsThumb.style.width = thumbWidthPercent + '%';

      // Move thumb
      const progress = Math.min(Math.max(swiperInstance.progress, 0), 1);
      const moveableSpace = 100 / thumbWidthPercent - 1;
      const moveX = progress * moveableSpace * 100;

      tsThumb.style.transform = `translateX(${moveX}%)`;
    }

    // FILTER LOGIC INTEGRATION
    const filterButtons = document.querySelectorAll('.filter-btn');
    const productSlides = document.querySelectorAll('#products-swiper .swiper-slide');

    function applyFilter(filter) {
      productSlides.forEach((slide) => {
        const tags = slide.dataset.tags || '';
        slide.style.display = tags.includes(filter) ? '' : 'none';
      });
      productSwiper.update(); // This triggers the 'update' event above
      productSwiper.slideTo(0); // Reset to start on filter
    }

    filterButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        filterButtons.forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        applyFilter(btn.dataset.filter);
      });
    });

    if (filterButtons.length) {
      applyFilter(filterButtons[0].dataset.filter);
    }
  });
</script>

{% schema %}
{
  "name": "Top Sellers with Filters",
  "settings": [
    {
      "type": "header",
      "content": "Visibility Settings"
    },
    {
      "type": "checkbox",
      "id": "show_navigation",
      "label": "Show Navigation Arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_progress_bar",
      "label": "Show Progress Bar",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "filter",
      "name": "Filter",
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Filter label",
          "default": "Freeze Dryers"
        },
        {
          "type": "text",
          "id": "tag",
          "label": "Product tag to filter",
          "default": "freeze dryers"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Browse Top Sellers",
      "blocks": [
        {
          "type": "filter",
          "settings": {
            "label": "Freeze Dryers",
            "tag": "freeze dryers"
          }
        },
        {
          "type": "filter",
          "settings": {
            "label": "Quest Dehumidifier",
            "tag": "quest"
          }
        },
        {
          "type": "filter",
          "settings": {
            "label": "Floraflex",
            "tag": "floraflex"
          }
        },
        {
          "type": "filter",
          "settings": {
            "label": "Dosatron",
            "tag": "dosatron"
          }
        }
      ]
    }
  ]
}
{% endschema %}

<script>

</script>
