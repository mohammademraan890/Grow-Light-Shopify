<style>
  #filter-btn-swiper .swiper-slide {
    width: auto !important;
  }

  .filter-btn {
    border: 1px solid #bec0c2;
    border-radius: 20px;
    padding: 5px 25px;
    background: #fff;
    cursor: pointer;
    white-space: nowrap;
  }

  .filter-btn.active {
    background: #414042;
    color: #fff;
  }
</style>
<style>
  /* Modal Overlay */
  .quick-view-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .quick-view-overlay.active {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
  }

  /* Modal Container */
  .quick-view-modal {
    background: white;
    border-radius: 8px;
    max-width: 900px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: transform 0.3s ease;
    position: relative;
  }

  .quick-view-overlay.active .quick-view-modal {
    transform: scale(1);
  }

  /* Close Button */
  .modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: white;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .modal-close:hover {
    background: #f3f4f6;
  }

  /* Main Image */
  .main-image-container {
    background: #fafafa;
    border-radius: 8px;
    overflow: hidden;
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .main-image-container img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  /* Thumbnail Swiper */
  .thumbnail-swiper {
    max-height: 200px !important   ;
    margin-top: 12px;
  }

  .thumbnail-swiper .swiper-slide {
    width: 70px;
    height: 70px;
    border: none;
    cursor: pointer;
    overflow: hidden;
    transition: border-color 0.2s;
    background: #fafafa;
  }

  /* .thumbnail-swiper .swiper-slide:hover {
    border-color: #006A2E;
  }

  .thumbnail-swiper .swiper-slide-thumb-active {
    border-color: #006A2E;
  } */

  .thumbnail-swiper .swiper-slide img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  /* Color Variants */
  .color-option {
    padding: 8px 16px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
  }

  .color-option:hover {
    border-color: #006a2e;
  }

  .color-option.active {
    background-color: #2b2b2b;
    color: white;
    border-color: #2b2b2b;
  }

  /* Quantity Selector */
  .quantity-selector {
    display: flex;
    align-items: center;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    overflow: hidden;
    width: fit-content;
  }

  .quantity-btn {
    background: white;
    border: none;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 18px;
    transition: background 0.2s;
  }

  .quantity-btn:hover {
    background: #f3f4f6;
  }

  .quantity-input {
    border: none;
    width: 60px;
    text-align: center;
    font-size: 16px;
    padding: 8px 0;
    border-left: 1px solid #d1d5db;
    border-right: 1px solid #d1d5db;
  }

  .quantity-input:focus {
    outline: none;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .quick-view-modal {
      width: 95%;
      max-height: 95vh;
    }
  }
</style>

<style>
  /* Navigation visibility */
  .ts-prev.swiper-button-disabled,
  .ts-next.swiper-button-disabled {
    opacity: 0;
    pointer-events: none;
  }

  .ts-prev,
  .ts-next {
    transition: opacity 0.3s ease;
  }

  /* Progress Bar Scoped to Top Sellers */
  .ts-progress-bar {
    width: 100%;
    height: 4px;
    background-color: #e9e9e9;
    border-radius: 2px;
    margin-top: 30px;
    position: relative;
    overflow: hidden;
  }

  .ts-progress-thumb {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background-color: #414042;
    border-radius: 2px;
    /* Using transform for performance, but the calculation is fixed below */
    transition: transform 0.5s ease;
    width: 0; /* Set dynamically by JS */
  }
</style>
<div class="custom-container mt-20!">
  <div class="flex item-center justify-between">
    <h1 class="text-[24px] font-bold text-[#414042] mb-4">Browse Top Sellers</h1>
    <a href="#" class="text-[#006A2E]! hidden md:flex items-center"
      >Shop all {% render 'svg-icons', name: 'chevron-right', icon_class: 'w-[20px] h-[20px] stroke-[#006A2E]' %}
    </a>
  </div>

  <div class="swiper" id="filter-btn-swiper">
    <div class="swiper-wrapper">
      {% for block in section.blocks %}
        <button
          class="swiper-slide filter-btn {% if forloop.first %}active{% endif %}"
          data-filter="{{ block.settings.tag | downcase }}"
          {{ block.shopify_attributes }}
        >
          {{ block.settings.label }}
        </button>
      {% endfor %}
    </div>
  </div>

  <div class="my-5">
    <div class="swiper py-10 relative" id="products-swiper">
      {% if section.settings.show_navigation %}
        <div
          class="
            ts-prev
            prev-swiper-button absolute left-0 top-1/2 -translate-y-1/2 z-10
            rounded-full cursor-pointer w-[40px] h-[40px]
            flex items-center justify-center bg-white shadow-xl
          "
        >
          {% render 'svg-icons', name: 'right-arrow', icon_class: 'w-[20px] h-[20px] rotate-180' %}
        </div>
      {% endif %}
      {% assign collection = collections['best-seller-products'] %}
      <div class="swiper-wrapper">
        {% if collection %}
          {% for product in collection.products %}
            <div
              class="swiper-slide w-[260px]!"
              data-tags="{{ product.tags | join: ',' | downcase }}"
            >
              <div class="w-[260px]! border border-transparent hover:border-[#0000001f] rounded-md p-2">
                <div class="relative bg-[#FAFAFA] rounded-md flex items-center justify-center">
                  <img
                    src="{{ product.featured_image | image_url: width: 300 }}"
                    alt="{{ product.title }}"
                    class="object-contain h-auto w-full"
                  >
                </div>

                <div class="mt-4">
                  <p class="text-[18px] font-semibold text-[#2B2B2B]">
                    {{ product.price | money }}
                  </p>

                  {% if product.compare_at_price > product.price %}
                    <p class="text-[14px] text-[#9B9B9B] line-through">
                      {{ product.compare_at_price | money }}
                    </p>
                  {% endif %}
                </div>

                <p class="mt-2 text-[14px] leading-[20px] text-[#414042]">
                  {{ product.title }}
                </p>

                <button
                  class="quick-view-btn relative group mt-4 w-full bg-[#006A2E] text-white text-[14px] font-medium py-2 rounded-sm hover:bg-[#005025] transition-colors"
                  data-product-handle="{{ product.handle }}"
                  data-product-price="{{ product.price | money }}"
                  data-product-compare-price="{% if product.compare_at_price > product.price %}{{ product.compare_at_price | money }}{% endif %}"
                >
                  Quick View
                  <div
                    class="btn-overlay absolute  bg-white z-10 w-full h-full top-0 left-0 opacity-0 scale-30 rounded-sm group-hover:scale-100 group-hover:opacity-30 duration-500 transition-all"
                  ></div>
                </button>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
      {% if section.settings.show_navigation %}
        <div
          class="
            ts-next
            next-swiper-button absolute right-0 top-1/2 -translate-y-1/2 z-10
            rounded-full cursor-pointer w-[40px] h-[40px]
            flex items-center justify-center bg-white shadow-xl
          "
        >
          {% render 'svg-icons', name: 'right-arrow', icon_class: 'w-[20px] h-[20px]' %}
        </div>
      {% endif %}
    </div>
    {% if section.settings.show_progress_bar %}
      <div class="ts-progress-bar">
        <div class="ts-progress-thumb" id="tsProgressThumb"></div>
      </div>
    {% endif %}
  </div>
</div>

<div class="quick-view-overlay" id="quickViewModal">
  <div class="quick-view-modal">
    <button class="modal-close" onclick="closeQuickView()">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
        <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>

    <div class="grid md:grid-cols-2 gap-6 p-6 md:p-8">
      <!-- Left Column - Images -->
      <div>
        <!-- Main Image Swiper -->
        <div class="swiper main-swiper">
          <div class="swiper-wrapper">
            <!-- Main images will be inserted here -->
          </div>
        </div>

        <!-- Thumbnail Swiper -->
        <div class="swiper thumbnail-swiper mt-4">
          <div class="swiper-wrapper">
            <!-- Thumbnails will be inserted here -->
          </div>
        </div>
      </div>

      <!-- Right Column - Product Details -->
      <div>
        <h2 class="text-[24px] md:text-[28px] font-semibold text-[#2B2B2B] mb-2" id="modalProductTitle"></h2>

        <div class="flex items-center gap-3 mb-4">
          <p class="text-[24px] font-bold text-[#2B2B2B]" id="modalProductPrice"></p>
          <p class="text-[18px] text-[#9B9B9B] line-through" id="modalProductComparePrice"></p>
        </div>

        <!-- Color Variants -->
        <div class="mb-6" id="colorVariantsSection" style="display: none;">
          <label class="block text-[14px] font-medium text-[#414042] mb-2">Color</label>
          <div class="flex flex-wrap gap-2" id="colorVariants">
            <!-- Color options will be inserted here -->
          </div>
        </div>

        <!-- Quantity Selector -->
        <div class="mb-6">
          <label class="block text-[14px] font-medium text-[#414042] mb-2">Quantity</label>
          <div class="quantity-selector">
            <button type="button" class="quantity-btn" onclick="decrementQuantity()">−</button>
            <input type="number" min="1" class="quantity-input" id="quantityInput" value="1" min="1">
            <button type="button" class="quantity-btn" onclick="incrementQuantity()">+</button>
          </div>
        </div>

        <!-- Add to Cart Button -->
        <button class="w-full bg-[#006A2E] text-white text-[16px] font-medium py-3 rounded-sm hover:bg-[#005025] transition-colors mb-3">
          Add to Cart
        </button>

        <!-- View Full Details -->
        <a
          href="#"
          id="viewFullDetailsLink"
          class="block w-full text-center border border-[#006A2E] text-[#006A2E] text-[16px] font-medium py-3 rounded-sm hover:bg-[#006A2E] hover:text-white transition-colors"
        >
          View Full Details →
        </a>

        <!-- Norton Badge (if applicable) -->
        <div class="mt-6 flex justify-center">
          <img
            src="https://via.placeholder.com/200x50?text=Norton+Badge"
            alt="Norton Shopping Guarantee"
            class="h-10"
          >
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const filterSwiper = new Swiper('#filter-btn-swiper', {
      slidesPerView: 'auto',

      spaceBetween: 10,

      freeMode: true,
    });
    const tsThumb = document.getElementById('tsProgressThumb');

    const productSwiper = new Swiper('#products-swiper', {
      slidesPerView: 'auto',
      spaceBetween: 16,
      watchOverflow: true,
      navigation: {
        nextEl: '.ts-next',
        prevEl: '.ts-prev',
        disabledClass: 'swiper-button-disabled',
      },
      {
      breakpoints: {
        640: {
          slidesPerView: 2,
          spaceBetween: 16,
        },
        768: {
          slidesPerView: 3  ,
          spaceBetween: 16,
        },
        1024: {
          slidesPerView: 4,
          spaceBetween: 16,
        },

      },

      on: {
        init: function () {
          updateTsProgress(this);
        },
        // 'setTranslate' catches dragging, 'slideChange' catches arrows
        setTranslate: function () {
          updateTsProgress(this);
        },
        breakpoint: function () {
          updateTsProgress(this);
        },
      },
    });

    function updateTsProgress(swiperInstance) {
      if (!tsThumb) return;

      // Filtered slides might be hidden, we only count visible ones
      const visibleSlidesCount = swiperInstance.slides.filter((slide) => slide.style.display !== 'none').length;
      if (visibleSlidesCount <= 1) {
        tsThumb.parentElement.style.display = 'none';
        return;
      } else {
        tsThumb.parentElement.style.display = 'block';
      }

      // Calculate width based on the current view
      const swiperWidth = swiperInstance.width;
      const totalContentWidth = swiperInstance.virtualSize;
      const thumbWidthPercent = Math.max((swiperWidth / totalContentWidth) * 100, 10);

      tsThumb.style.width = thumbWidthPercent + '%';

      // Move thumb
      const progress = Math.min(Math.max(swiperInstance.progress, 0), 1);
      const moveableSpace = 100 / thumbWidthPercent - 1;
      const moveX = progress * moveableSpace * 100;

      tsThumb.style.transform = `translateX(${moveX}%)`;
    }

    // FILTER LOGIC INTEGRATION
    const filterButtons = document.querySelectorAll('.filter-btn');
    const productSlides = document.querySelectorAll('#products-swiper .swiper-slide');

    function applyFilter(filter) {
      productSlides.forEach((slide) => {
        const tags = slide.dataset.tags || '';
        slide.style.display = tags.includes(filter) ? '' : 'none';
      });
      productSwiper.update(); // This triggers the 'update' event above
      productSwiper.slideTo(0); // Reset to start on filter
    }

    filterButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        filterButtons.forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        applyFilter(btn.dataset.filter);
      });
    });

    if (filterButtons.length) {
      applyFilter(filterButtons[0].dataset.filter);
    }
  });
</script>

{% schema %}
{
  "name": "Top Sellers with Filters",
  "settings": [
    {
      "type": "header",
      "content": "Visibility Settings"
    },
    {
      "type": "checkbox",
      "id": "show_navigation",
      "label": "Show Navigation Arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_progress_bar",
      "label": "Show Progress Bar",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "filter",
      "name": "Filter",
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Filter label",
          "default": "Freeze Dryers"
        },
        {
          "type": "text",
          "id": "tag",
          "label": "Product tag to filter",
          "default": "freeze dryers"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Browse Top Sellers",
      "blocks": [
        {
          "type": "filter",
          "settings": {
            "label": "Freeze Dryers",
            "tag": "freeze dryers"
          }
        },
        {
          "type": "filter",
          "settings": {
            "label": "Quest Dehumidifier",
            "tag": "quest"
          }
        },
        {
          "type": "filter",
          "settings": {
            "label": "Floraflex",
            "tag": "floraflex"
          }
        },
        {
          "type": "filter",
          "settings": {
            "label": "Dosatron",
            "tag": "dosatron"
          }
        }
      ]
    }
  ]
}
{% endschema %}

<script>
  let mainSwiper;
  let thumbnailSwiper;
  let currentProductData = null;

  // Simple swiper initialization
  function initializeSwipers() {
    if (mainSwiper) mainSwiper.destroy(true, true);
    if (thumbnailSwiper) thumbnailSwiper.destroy(true, true);

    mainSwiper = new Swiper('.main-swiper', {
      spaceBetween: 10,
      fade: true,
      slidesPerView: 1,
      loop: false,
    });

    thumbnailSwiper = new Swiper('.thumbnail-swiper', {
      direction: 'vertical',
      spaceBetween: 8,
      slidesPerView: 'auto',
      loop: false,
    });

    // Link swipers
    mainSwiper.controller.control = thumbnailSwiper;
    thumbnailSwiper.controller.control = mainSwiper;
  }

  // Fetch product data from Shopify
  async function fetchProductData(productHandle) {
    try {
      const response = await fetch(`/products/${productHandle}.js`);
      if (!response.ok) throw new Error('Product not found');
      const data = await response.json();
      console.log('Product data received:', data);
      return data;
    } catch (error) {
      console.error('Error fetching product:', error);
      return null;
    }
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM loaded - setting up quick view');

    // Use event delegation
    document.addEventListener('click', async function (e) {
      if (e.target.closest('.quick-view-btn')) {
        e.preventDefault();
        e.stopPropagation();

        const button = e.target.closest('.quick-view-btn');
        const productHandle = button.dataset.productHandle;

        console.log('Fetching product:', productHandle);

        // Show loading state
        const modal = document.getElementById('quickViewModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Display loading message
        document.getElementById('modalProductTitle').textContent = 'Loading...';

        // Fetch product data
        const productData = await fetchProductData(productHandle);

        if (productData) {
          openQuickView(productData, button);
        } else {
          console.error('Failed to load product');
          closeQuickView();
        }
      }
    });
  });

  function openQuickView(productData, button) {
    console.log('Opening quick view for:', productData);

    currentProductData = productData;

    // Populate product info
    document.getElementById('modalProductTitle').textContent = productData.title;
    document.getElementById('modalProductPrice').textContent = formatMoney(productData.price);
    document.getElementById('viewFullDetailsLink').href = `/products/${productData.handle}`;

    // Handle compare price
    const comparePriceEl = document.getElementById('modalProductComparePrice');
    if (productData.compare_at_price && productData.compare_at_price > productData.price) {
      comparePriceEl.textContent = formatMoney(productData.compare_at_price);
      comparePriceEl.style.display = 'block';
    } else {
      comparePriceEl.style.display = 'none';
    }

    // Load images - FIXED THIS
    loadProductImages(productData);

    // Load variants
    loadColorVariants(productData.variants);

    // Reset quantity
    document.getElementById('quantityInput').value = 1;
  }

  function loadProductImages(productData) {
    const mainWrapper = document.querySelector('.main-swiper .swiper-wrapper');
    const thumbWrapper = document.querySelector('.thumbnail-swiper .swiper-wrapper');

    mainWrapper.innerHTML = '';
    thumbWrapper.innerHTML = '';

    console.log('Product images:', productData.images);

    // Check if images exist and have the right structure
    if (!productData.images || productData.images.length === 0) {
      console.error('No images found for product');
      // Use featured image as fallback
      if (productData.featured_image) {
        const mainSlide = document.createElement('div');
        mainSlide.className = 'swiper-slide';
        mainSlide.innerHTML = `<img src="${productData.featured_image}" alt="${productData.title}" class="w-full h-auto object-contain">`;
        mainWrapper.appendChild(mainSlide);

        const thumbSlide = document.createElement('div');
        thumbSlide.className = 'swiper-slide cursor-pointer';
        thumbSlide.innerHTML = `<img src="${productData.featured_image}" alt="${productData.title}" class="w-20 h-20 object-cover border">`;
        thumbWrapper.appendChild(thumbSlide);
      }
    } else {
      // Create slides for each image
      productData.images.forEach((image, index) => {
        // Handle different image formats (could be string or object)
        const imageSrc = typeof image === 'string' ? image : image.src;
        const imageAlt = typeof image === 'object' && image.alt ? image.alt : productData.title;

        console.log(`Image ${index}:`, imageSrc);

        const mainSlide = document.createElement('div');
        mainSlide.className = 'swiper-slide';
        mainSlide.innerHTML = `<div class="main-image-container"><img src="${imageSrc}" alt="${imageAlt}" class="w-full h-full object-contain"></div>`;
        mainWrapper.appendChild(mainSlide);

        const thumbSlide = document.createElement('div');
        thumbSlide.className = 'swiper-slide cursor-pointer';
        thumbSlide.innerHTML = `<img src="${imageSrc}" alt="${imageAlt}" class="w-full h-full object-contain">`;
        thumbWrapper.appendChild(thumbSlide);
      });
    }

    // Initialize swipers after a small delay to ensure DOM is updated
    setTimeout(() => {
      initializeSwipers();

      // Bind thumbnail clicks
      document.querySelectorAll('.thumbnail-swiper .swiper-slide').forEach((slide, index) => {
        slide.addEventListener('click', () => {
          mainSwiper.slideTo(index);
        });
      });
    }, 100);
  }

  function loadColorVariants(variants) {
    const section = document.getElementById('colorVariantsSection');
    const container = document.getElementById('colorVariants');

    container.innerHTML = '';

    // Check if product has color options (option1)
    const colors = [...new Set(variants.map((v) => v.option1).filter(Boolean))];

    if (colors.length <= 1) {
      section.style.display = 'none';
      return;
    }

    section.style.display = 'block';

    colors.forEach((color, index) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'color-option' + (index === 0 ? ' active' : '');
      btn.textContent = color;

      btn.addEventListener('click', () => {
        updateVariantByColor(color, variants);
      });

      container.appendChild(btn);
    });

    // Set default variant
    if (colors.length > 0) {
      updateVariantByColor(colors[0], variants);
    }
  }

  function updateVariantByColor(color, variants) {
    // Update active color button
    document.querySelectorAll('.color-option').forEach((btn) => {
      btn.classList.toggle('active', btn.textContent === color);
    });

    // Find variant for this color
    const variant = variants.find((v) => v.option1 === color);
    if (!variant) return;

    // Update price
    document.getElementById('modalProductPrice').textContent = formatMoney(variant.price);

    const compareEl = document.getElementById('modalProductComparePrice');
    if (variant.compare_at_price && variant.compare_at_price > variant.price) {
      compareEl.textContent = formatMoney(variant.compare_at_price);
      compareEl.style.display = 'block';
    } else {
      compareEl.style.display = 'none';
    }
  }

  function formatMoney(cents) {
    return `$${(cents / 100).toFixed(2)}`;
  }

  function closeQuickView() {
    const modal = document.getElementById('quickViewModal');
    modal.classList.remove('active');
    document.body.style.overflow = '';

    // Clear content
    document.getElementById('modalProductTitle').textContent = '';
    document.getElementById('modalProductPrice').textContent = '';
    document.getElementById('modalProductComparePrice').style.display = 'none';

    const mainWrapper = document.querySelector('.main-swiper .swiper-wrapper');
    const thumbWrapper = document.querySelector('.thumbnail-swiper .swiper-wrapper');
    if (mainWrapper) mainWrapper.innerHTML = '';
    if (thumbWrapper) thumbWrapper.innerHTML = '';
  }

  // Close modal on overlay click
  document.getElementById('quickViewModal').addEventListener('click', function (e) {
    if (e.target === this || e.target.closest('.modal-close')) {
      closeQuickView();
    }
  });

  // Close on Escape key
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      closeQuickView();
    }
  });

  function incrementQuantity() {
    const input = document.getElementById('quantityInput');
    input.value = parseInt(input.value) + 1;
  }

  function decrementQuantity() {
    const input = document.getElementById('quantityInput');
    if (parseInt(input.value) > 1) {
      input.value = parseInt(input.value) - 1;
    }
  }
</script>
